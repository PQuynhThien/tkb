<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TKB 12A8 - Cloud Sync Pro</title>
    <style>
        :root { 
            --bg-dark: #0a0a0a; 
            --card-bg: #1a1a1b;
            --border-color: #333; 
            --text-main: #e8eaed; 
            --accent-blue: #8ab4f8; 
            --accent-green: #81c995;
        }
        
        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* UI Main */
        #main-ui { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 10px; box-sizing: border-box; }
        
        .led-border { 
            padding: 2px; border-radius: 12px; 
            background: linear-gradient(90deg, #ff0000, #00f2ff, #7a00ff, #ff0000); 
            background-size: 300%; animation: led-run 8s linear infinite;
            width: 100%; max-width: 800px;
        }
        @keyframes led-run { 0% { background-position: 0%; } 100% { background-position: 300%; } }

        .container { background: #0f0f0f; border-radius: 10px; padding: 15px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        table { border-collapse: collapse; width: 100%; min-width: 550px; }
        th, td { border: 1px solid #222; padding: 12px 8px; text-align: center; font-size: 14px; }
        th { color: var(--accent-blue); background: #151515; font-weight: 600; }
        td[contenteditable="true"]:focus { background: rgba(138, 180, 248, 0.1); outline: none; }

        /* Secret Page */
        #secret-page { display: none; background-color: var(--bg-dark); min-height: 100vh; flex-direction: column; }
        .keep-nav { 
            display: flex; align-items: center; padding: 10px 15px; 
            background: #1e1e1e; border-bottom: 1px solid var(--border-color);
            position: sticky; top: 0; z-index: 100; gap: 10px;
        }

        /* Buttons */
        .btn-ui { 
            padding: 10px 18px; border-radius: 8px; border: 1px solid var(--border-color); 
            background: #252525; color: var(--text-main); cursor: pointer; font-weight: 500;
            transition: 0.2s; white-space: nowrap;
        }
        .btn-ui:active { transform: scale(0.95); }
        .btn-primary { background: var(--accent-blue); color: #000; border: none; }

        /* Notes Grid */
        #notes-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 12px; padding: 15px; 
        }
        @media (min-width: 600px) { #notes-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); } }

        .note-card { 
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; 
            padding: 12px; height: 140px; overflow: hidden; cursor: pointer;
        }

        /* Utils */
        .status-tag { font-size: 11px; padding: 4px 8px; border-radius: 12px; }
        .status-saved { color: var(--accent-green); background: rgba(129, 201, 149, 0.1); }
        .status-saving { color: #fdd663; background: rgba(253, 214, 99, 0.1); }
        
        #v-key { background: rgba(255,255,255,0.03); caret-color: var(--accent-blue); }
    </style>
</head>
<body>

    <div id="main-ui">
        <div class="led-border">
            <div class="container">
                <h3 style="text-align:center; margin: 10px 0; color:var(--accent-blue)">12A8 SCHEDULE ‚òÅÔ∏è</h3>
                <table>
                    <thead><tr><th>Ti·∫øt</th><th>T2</th><th>T3</th><th>T4</th><th>T5</th><th>T6</th><th>T7</th></tr></thead>
                    <tbody id="tkbBody"></tbody>
                </table>
            </div>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px; align-items:center">
            <button class="btn-ui btn-primary" onclick="manualSave()">üíæ L∆ØU ƒê√ÅM M√ÇY</button>
            <span id="sync-status" class="status-tag status-saved">ƒê√£ k·∫øt n·ªëi</span>
        </div>
    </div>

    <div id="secret-page">
        <nav class="keep-nav">
            <span style="flex-grow:1; font-weight:bold; font-size:16px">B√ç M·∫¨T ü§´</span>
            <div id="cloud-status-text" class="status-tag status-saved">üü¢ Cloud OK</div>
            <button class="btn-ui" onclick="exitSecret()">ƒê√ìNG</button>
        </nav>
        
        <div id="notes-container" style="padding: 10px;">
            <div style="background: #1e1e1e; border-radius: 12px; padding: 5px; margin-bottom: 20px; border: 1px solid #333">
                <input type="text" id="note-quick-title" placeholder="Ghi ch√∫ nhanh..." style="width:100%; background:transparent; border:none; color:white; padding:10px; outline:none">
            </div>
            <div id="notes-grid"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBbkwe6VSL_E3QSykRvlzAJBYjhDegCtv8",
            authDomain: "htgdfg-45e29.firebaseapp.com",
            projectId: "htgdfg-45e29",
            storageBucket: "htgdfg-45e29.firebasestorage.app",
            messagingSenderId: "592286526717",
            appId: "1:592286526717:web:c3f1b01a6eaddefeaa2294"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const cloudRef = ref(db, 'master_data');

        // State & Local Cache
        let state = {
            tkb: JSON.parse(localStorage.getItem('tkb')) || [],
            notes: JSON.parse(localStorage.getItem('notes')) || [],
            password: "Thi·ªán dz"
        };

        // 1. HI·ªÜN TKB NGAY L·∫¨P T·ª®C (OPTIMISTIC UI)
        renderTKB(state.tkb);

        // 2. L·∫ÆNG NGHE CLOUD (CH·ªà C·∫¨P NH·∫¨T KHI C√ì THAY ƒê·ªîI TH·ª∞C S·ª∞)
        onValue(cloudRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const isDifferent = JSON.stringify(data.tkb) !== JSON.stringify(state.tkb);
                state = data;
                localStorage.setItem('tkb', JSON.stringify(data.tkb));
                localStorage.setItem('notes', JSON.stringify(data.notes));
                if (isDifferent) renderTKB(data.tkb);
                updateStatusUI('saved');
            }
        });

        // 3. RENDER TKB
        function renderTKB(data) {
            const tbody = document.getElementById('tkbBody');
            const def = [["1","SHDC","HDTN","QP","L√Ω","To√°n","TD"],["2","Anh","H√≥a","GD","S·ª≠","To√°n","H√≥a"],["3","H√≥a","L√Ω","VƒÉn","","TD","Anh"],["4","VƒÉn","GD","To√°n","","Tin","Anh"],["5","VƒÉn","Tin","To√°n","","L√Ω","SHL"]];
            const rows = data.length ? data : def;
            
            tbody.innerHTML = rows.map((row, rIdx) => `
                <tr>
                    ${row.map((cell, cIdx) => {
                        const isKey = (rIdx === 3 && cIdx === 4);
                        return `<td ${cIdx !== 0 ? 'contenteditable="true"' : ''} 
                                    ${isKey ? 'id="v-key" style="background:rgba(138,180,248,0.1)"' : ''}>
                                    ${isKey ? '' : cell}</td>`;
                    }).join('')}
                </tr>
            `).join('');

            // S·ª± ki·ªán g√µ m·∫≠t kh·∫©u (v√†o th·∫≥ng kh√¥ng c·∫ßn Enter)
            const vKey = document.getElementById('v-key');
            vKey.addEventListener('input', () => {
                if (vKey.innerText.trim() === state.password) {
                    vKey.innerText = "";
                    unlock();
                }
            });
        }

        // 4. L∆ØU D·ªÆ LI·ªÜU (T·ªêI ∆ØU)
        async function manualSave() {
            updateStatusUI('saving');
            
            // C·∫≠p nh·∫≠t state t·ª´ DOM
            const rows = document.querySelectorAll('#tkbBody tr');
            state.tkb = Array.from(rows).map((r, rIdx) => 
                Array.from(r.querySelectorAll('td')).map((td, cIdx) => 
                    (rIdx === 3 && cIdx === 4) ? "" : td.innerText
                )
            );

            try {
                await set(cloudRef, state);
                localStorage.setItem('tkb', JSON.stringify(state.tkb));
                updateStatusUI('saved');
            } catch (e) {
                alert("L·ªói k·∫øt n·ªëi! D·ªØ li·ªáu ƒë√£ l∆∞u t·∫°m ·ªü m√°y.");
                updateStatusUI('error');
            }
        }

        // 5. TRANG B√ç M·∫¨T
        function unlock() {
            document.getElementById('main-ui').style.display = 'none';
            document.getElementById('secret-page').style.display = 'flex';
            renderNotes();
        }

        window.exitSecret = () => {
            document.getElementById('secret-page').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex';
        };

        function renderNotes() {
            const grid = document.getElementById('notes-grid');
            grid.innerHTML = state.notes.map(n => `
                <div class="note-card">
                    <div style="font-weight:bold; margin-bottom:5px">${n.title || 'Ghi ch√∫'}</div>
                    <div style="font-size:13px; opacity:0.8">${n.body || ''}</div>
                </div>
            `).join('');
        }

        function updateStatusUI(status) {
            const el = document.getElementById('sync-status');
            const el2 = document.getElementById('cloud-status-text');
            if (status === 'saving') {
                el.innerText = el2.innerText = "ƒêang l∆∞u...";
                el.className = el2.className = "status-tag status-saving";
            } else {
                el.innerText = el2.innerText = "ƒê√£ l∆∞u Cloud";
                el.className = el2.className = "status-tag status-saved";
            }
        }

        window.manualSave = manualSave;
    </script>
</body>
</html>
