<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TKB 12A8 - Cloud Sync Status</title>
    <style>
        :root { --bg-dark: #202124; --border-color: #5f6368; --text-main: #e8eaed; --accent-blue: #8ab4f8; }
        body { background-color: #050505; color: var(--text-main); font-family: 'Segoe UI', Arial, sans-serif; margin: 0; }
        
        /* T·ªëi ∆∞u UI ch√≠nh */
        #main-ui { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 10px; box-sizing: border-box; }
        .led-border { padding: 3px; border-radius: 12px; background: linear-gradient(90deg, #ff0000, #00f2ff, #7a00ff, #ff0000); background-size: 300%; animation: led-run 10s linear infinite; width: 100%; max-width: 800px; }
        @keyframes led-run { 0% { background-position: 0% 50%; } 100% { background-position: 300% 50%; } }
        
        .container { background: #0f0f0f; border-radius: 10px; padding: 15px; box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow-x: auto; }
        
        /* T·ªëi ∆∞u Table cho Mobile */
        table { border-collapse: collapse; width: 100%; border: 1px solid #333; font-size: 14px; }
        th, td { border: 1px solid #333; padding: 8px 4px; text-align: center; min-width: 60px; }
        th { color: var(--accent-blue); background: #1a1a1a; font-size: 12px; }
        
        #secret-page { display: none; background-color: var(--bg-dark); min-height: 100vh; flex-direction: column; align-items: center; padding-bottom: 50px; }
        
        /* Nav t·ªëi ∆∞u mobile */
        .keep-nav { width: 100%; padding: 10px; display: flex; flex-wrap: wrap; align-items: center; border-bottom: 1px solid var(--border-color); background: var(--bg-dark); position: sticky; top: 0; z-index: 100; gap: 8px; box-sizing: border-box; }
        
        #album-view { display: none; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px; width: 95%; max-width: 1300px; margin-top: 20px; }
        .album-item { position: relative; aspect-ratio: 1/1; border-radius: 8px; overflow: hidden; border: 1px solid #444; background: #111; }
        .album-item img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: 0.3s; }
        
        .del-photo { position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.8); border: none; color: white; border-radius: 3px; cursor: pointer; padding: 4px 8px; font-size: 10px; z-index: 5; }

        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; }
        #lightbox img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .view-btn { background: #3c4043; border: 1px solid #5f6368; color: white; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 12px; }
        .view-btn.active { background: var(--accent-blue); color: black; font-weight: bold; }

        #notes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; width: 95%; max-width: 1300px; margin-top: 20px; }
        
        /* HI·ªÜU ·ª®NG L√ÄM M·ªú N·ªÄN GHI CH√ö */
        .note-card { border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.3s; overflow: hidden; height: 180px; position: relative; background-size: cover; background-position: center; }
        .note-card.has-bg::before { 
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0, 0, 0, 0.5); /* ƒê·ªô m·ªù ƒëen gi√∫p ch·ªØ n·ªïi b·∫≠t */
            backdrop-filter: blur(2px); /* L√†m m·ªù nh·∫π h√¨nh n·ªÅn */
            z-index: 1; 
        }
        .note-card .content-wrapper { position: relative; z-index: 2; height: 100%; }

        /* Modal Edit t·ªëi ∆∞u cho mobile */
        #edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { width: 95%; height: 90%; border-radius: 15px; border: 1px solid var(--border-color); background: var(--bg-dark); background-size: cover; background-position: center; position: relative; overflow: hidden; }
        .modal-content.has-bg::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1;
        }
        .modal-inner { position: relative; z-index: 2; display: flex; flex-direction: column; height: 100%; }
        
        .toolbar { display: flex; flex-wrap: wrap; gap: 5px; padding: 8px; background: rgba(30, 31, 34, 0.9); border-bottom: 1px solid var(--border-color); }
        .tool-btn { background: #3c4043; border: 1px solid #5f6368; color: white; padding: 5px 8px; border-radius: 4px; font-size: 11px; }
        #editor-body { flex-grow: 1; padding: 20px; outline: none; overflow-y: auto; line-height: 1.6; }

        .btn-ui { padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border-color); background: transparent; color: var(--accent-blue); cursor: pointer; font-weight: bold; font-size: 13px; }
        .input-wrapper { width: 95%; margin-top: 20px; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; }
        
        .c-default { background-color: #202124 !important; }
        .c-red { background-color: #5c2b29 !important; }
        .c-green { background-color: #345920 !important; }
        .c-blue { background-color: #2d555e !important; }
        
        #v-key { transition: background 0.3s; outline: none; min-width: 40px; }
    </style>
</head>
<body>

    <div id="main-ui">
        <div class="led-border"><div class="container">
            <h2 style="text-align:center; color:var(--accent-blue); margin: 10px 0;">12A8 SCHEDULE ‚òÅÔ∏è</h2>
            <table>
                <thead><tr><th>Ti·∫øt</th><th>T2</th><th>T3</th><th>T4</th><th>T5</th><th>T6</th><th>T7</th></tr></thead>
                <tbody id="tkbBody"></tbody>
            </table>
        </div></div>
        <button class="btn-ui" style="margin-top:20px" onclick="uploadTKB()">üíæ L∆ØU L·∫†I</button>
        <div id="sync-status-main" style="margin-top:10px; font-size:12px; color:#81c995">ƒê√£ k·∫øt n·ªëi</div>
    </div>

    <div id="secret-page">
        <nav class="keep-nav">
            <div style="flex-grow:1; display: flex; align-items: center; gap: 8px;">
                <button id="btn-view-notes" class="view-btn active" onclick="switchView('notes')">Ghi ch√∫</button>
                <button id="btn-view-album" class="view-btn" onclick="switchView('album')">Album</button>
            </div>
            <button class="btn-ui" style="color:#ff9800; padding: 4px 8px; font-size: 11px;" onclick="changePassword()">üîë PASS</button>
            <button class="btn-ui" style="padding: 4px 8px; font-size: 11px;" onclick="exitSecret()">ƒê√ìNG</button>
        </nav>
        
        <div id="notes-container" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <div class="input-wrapper">
                <input type="text" id="new-title" placeholder="Ghi ch√∫ m·ªõi..." onclick="document.getElementById('new-body-editor').style.display='block'; document.getElementById('new-actions').style.display='flex'">
                <div id="new-body-editor" contenteditable="true" style="display:none; padding:12px 15px; outline:none; border-top:1px solid #444; min-height: 100px;"></div>
                <div id="new-actions" style="display:none; padding:10px; justify-content:flex-end;"><button class="btn-ui" onclick="addNote()">Xong</button></div>
            </div>
            <div id="notes-grid"></div>
        </div>

        <div id="album-view"></div>
    </div>

    <div id="lightbox" onclick="this.style.display='none'">
        <img id="lightbox-img" src="" alt="Full view">
    </div>

    <div id="edit-modal"><div class="modal-content" id="modal-box"><div class="modal-inner">
        <div class="toolbar">
            <button class="tool-btn" onclick="execCmd('bold')">B</button>
            <button class="tool-btn" onclick="insertCheckbox()">‚òë</button>
            <input type="color" id="colorPicker" onchange="execCmd('foreColor', this.value)" style="width:25px; height:25px; border:none; background:none;">
            <button class="tool-btn" onclick="document.getElementById('imgInput').click()">üñº ·∫¢nh</button>
            <button class="tool-btn" onclick="document.getElementById('themeImgInput').click()">üåÑ N·ªÅn</button>
            <input type="file" id="imgInput" style="display:none" accept="image/*" onchange="handleImage(event)">
            <input type="file" id="themeImgInput" style="display:none" accept="image/*" onchange="handleThemeImage(event)">
            <div style="flex-grow:1"></div>
            <div style="display:flex; gap:5px">
                <div onclick="setNoteTheme('c-default')" style="width:18px; height:18px; border-radius:50%; background:#202124; border:1px solid white;"></div>
                <div onclick="setNoteTheme('c-red')" style="width:18px; height:18px; border-radius:50%; background:#5c2b29;"></div>
                <div onclick="setNoteTheme('c-green')" style="width:18px; height:18px; border-radius:50%; background:#345920;"></div>
                <div onclick="setNoteTheme('c-blue')" style="width:18px; height:18px; border-radius:50%; background:#2d555e;"></div>
            </div>
        </div>
        <input type="text" id="editor-title" placeholder="Ti√™u ƒë·ªÅ" style="width:100%; background:transparent; border:none; color:white; padding:15px; font-size:1.1em; outline:none; font-weight:bold">
        <div id="editor-body" contenteditable="true"></div>
        <div style="padding:10px; text-align:right; border-top:1px solid #444; display:flex; justify-content:space-between">
            <button class="btn-ui" style="color:#ff4d4d" onclick="deleteNote()">üóë X√≥a</button>
            <button class="btn-ui" style="background:var(--accent-blue); color:black" onclick="closeEdit()">L∆∞u</button>
        </div>
    </div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBbkwe6VSL_E3QSykRvlzAJBYjhDegCtv8",
            authDomain: "htgdfg-45e29.firebaseapp.com",
            projectId: "htgdfg-45e29",
            storageBucket: "htgdfg-45e29.firebasestorage.app",
            messagingSenderId: "592286526717",
            appId: "1:592286526717:web:c3f1b01a6eaddefeaa2294",
            measurementId: "G-GW7TN1VTXD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const cloudRef = ref(db, 'master_data');

        let notes = [];
        let tkbData = [];
        let album = [];
        let cloudPass = "Thi·ªán dz";
        let currentId = null;

        window.unlock = function() {
            const inputPass = document.getElementById('v-key').innerText.trim();
            if (inputPass === cloudPass) {
                document.getElementById('main-ui').style.display = 'none';
                document.getElementById('secret-page').style.display = 'flex';
                document.getElementById('v-key').innerText = ""; 
            } else {
                const vKey = document.getElementById('v-key');
                vKey.style.backgroundColor = "rgba(255,0,0,0.3)";
                setTimeout(() => vKey.style.backgroundColor = "transparent", 500);
            }
        }

        window.exitSecret = function() {
            document.getElementById('secret-page').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex';
        }

        window.switchView = function(view) {
            document.getElementById('notes-container').style.display = (view === 'notes' ? 'flex' : 'none');
            document.getElementById('album-view').style.display = (view === 'album' ? 'grid' : 'none');
            document.getElementById('btn-view-notes').className = 'view-btn' + (view === 'notes' ? ' active' : '');
            document.getElementById('btn-view-album').className = 'view-btn' + (view === 'album' ? ' active' : '');
            if(view === 'album') renderAlbum();
        }

        window.saveToCloud = function() {
            updateStatus('saving');
            const tkbRows = document.querySelectorAll('#tkbBody tr');
            const currentTkbTable = Array.from(tkbRows).map((r, rIdx) => {
                return Array.from(r.querySelectorAll('td')).map((td, cIdx) => (rIdx === 3 && cIdx === 4) ? "" : td.innerText);
            });
            set(cloudRef, {
                notes: notes,
                tkb: currentTkbTable,
                album: album,
                password: cloudPass
            }).then(() => updateStatus('saved'));
        };

        window.uploadTKB = function() { window.saveToCloud(); };

        onValue(cloudRef, (snapshot) => {
            const val = snapshot.val();
            if (val) {
                notes = val.notes || [];
                tkbData = val.tkb || [];
                album = val.album || [];
                cloudPass = val.password || "Thi·ªán dz";
            }
            initTKB(tkbData);
            renderNotes();
            renderAlbum();
        });

        window.renderAlbum = function() {
            const albumView = document.getElementById('album-view');
            albumView.innerHTML = `
                <div class="album-item" onclick="document.getElementById('albumUpload').click()" style="display:flex; flex-direction:column; align-items:center; justify-content:center; border:2px dashed #555; color:#888; cursor:pointer">
                    <span style="font-size:30px">+</span><small>Th√™m</small>
                    <input type="file" id="albumUpload" style="display:none" accept="image/*" onchange="addPhoto(event)">
                </div>
            `;
            album.forEach((imgSrc, index) => {
                const item = document.createElement('div');
                item.className = 'album-item';
                item.innerHTML = `
                    <img src="${imgSrc}" onclick="viewFullImage('${imgSrc}')">
                    <button class="del-photo" onclick="event.stopPropagation(); deletePhoto(${index})">X√≥a</button>
                `;
                albumView.appendChild(item);
            });
        }

        window.viewFullImage = function(src) {
            const lb = document.getElementById('lightbox');
            const lbImg = document.getElementById('lightbox-img');
            lbImg.src = src;
            lb.style.display = 'flex';
        }

        window.addPhoto = function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                album.unshift(ev.target.result);
                window.saveToCloud();
            };
            reader.readAsDataURL(file);
        }

        window.deletePhoto = function(index) {
            if(confirm("X√≥a ·∫£nh kh·ªèi Album?")) {
                album.splice(index, 1);
                window.saveToCloud();
            }
        }

        window.renderNotes = function() {
            const grid = document.getElementById('notes-grid'); 
            grid.innerHTML = "";
            notes.forEach(n => {
                const card = document.createElement('div');
                card.className = `note-card ${n.bgImg ? 'has-bg' : (n.color || 'c-default')}`;
                if (n.bgImg) card.style.backgroundImage = `url(${n.bgImg})`;
                card.onclick = () => openEdit(n.id);
                card.innerHTML = `
                    <div class="content-wrapper">
                        <div style="font-weight:bold; margin-bottom:8px">${n.title || 'Ghi ch√∫'}</div>
                        <div style="font-size:13px; max-height:110px; overflow:hidden">${n.body}</div>
                    </div>`;
                grid.appendChild(card);
            });
        }

        window.addNote = function() {
            const t = document.getElementById('new-title').value;
            const b = document.getElementById('new-body-editor').innerHTML;
            if(t || b) {
                notes.unshift({ 
                    id: Date.now(), 
                    title: t, 
                    body: b, 
                    color: 'c-default', 
                    bgImg: null 
                });
                window.saveToCloud();
                document.getElementById('new-title').value = ""; 
                document.getElementById('new-body-editor').innerHTML = ""; 
                document.getElementById('new-body-editor').style.display = 'none';
            }
        }

        window.openEdit = (id) => {
            currentId = id; 
            const n = notes.find(x => x.id === id); 
            document.getElementById('editor-title').value = n.title || ""; 
            document.getElementById('editor-body').innerHTML = n.body || ""; 
            applyTheme(n.color, n.bgImg);
            document.getElementById('edit-modal').style.display = 'flex'; 
        }

        window.closeEdit = () => {
            const n = notes.find(x => x.id === currentId);
            n.title = document.getElementById('editor-title').value;
            const editor = document.getElementById('editor-body');
            const checkboxes = editor.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (cb.checked) cb.setAttribute('checked', 'checked');
                else cb.removeAttribute('checked');
            });
            n.body = editor.innerHTML;
            window.saveToCloud();
            document.getElementById('edit-modal').style.display = 'none';
        }

        window.execCmd = (c, v=null) => {
            document.execCommand(c, false, v);
            document.getElementById('editor-body').focus();
        };

        window.insertCheckbox = function() {
            const html = `<div><input type="checkbox" class="editor-cb">&nbsp;</div>`;
            execCmd('insertHTML', html);
        }

        window.setNoteTheme = (cls) => {
            const n = notes.find(x => x.id === currentId);
            n.color = cls;
            n.bgImg = null;
            applyTheme(cls, null);
        }

        function applyTheme(cls, img) {
            const box = document.getElementById('modal-box');
            if (img) { 
                box.style.backgroundImage = `url(${img})`; 
                box.className = 'modal-content has-bg'; 
            } else { 
                box.style.backgroundImage = ''; 
                box.className = `modal-content ${cls || 'c-default'}`; 
            }
        }

        window.handleImage = (e) => {
            const r = new FileReader();
            r.onload = ev => { 
                execCmd('insertHTML', `<img src="${ev.target.result}" style="max-width:100%; border-radius:8px" onclick="window.viewFullImage('${ev.target.result}')"><br>`); 
            };
            r.readAsDataURL(e.target.files[0]);
        }

        window.handleThemeImage = (e) => {
            const r = new FileReader();
            r.onload = ev => { 
                const n = notes.find(x => x.id === currentId); 
                n.bgImg = ev.target.result; 
                applyTheme(null, ev.target.result); 
            };
            r.readAsDataURL(e.target.files[0]);
        }

        window.deleteNote = () => { 
            if(confirm("X√≥a ghi ch√∫ n√†y?")) { 
                notes = notes.filter(x => x.id !== currentId); 
                window.saveToCloud(); 
                document.getElementById('edit-modal').style.display = 'none'; 
            } 
        }

        window.changePassword = function() {
            const p = prompt("M·∫≠t kh·∫©u m·ªõi:", cloudPass);
            if(p) { cloudPass = p; window.saveToCloud(); }
        }

        function updateStatus(t) {
            const el = document.getElementById('cloud-status-text');
            if (t==='saving') { el.innerText="üü° ƒêang l∆∞u..."; el.className="status-saving"; }
            else { el.innerText="üü¢ ƒê√£ l∆∞u Cloud"; el.className="status-saved"; }
        }

        function initTKB(data) {
            const tbody = document.getElementById('tkbBody'); 
            tbody.innerHTML = "";
            const def = [["1","SHDC","HDTN","QP","L√Ω","To√°n","TD"],["2","Anh","H√≥a","GD","S·ª≠","To√°n","H√≥a"],["3","H√≥a","L√Ω","VƒÉn","","TD","Anh"],["4","VƒÉn","GD","To√°n","","Tin","Anh"],["5","VƒÉn","Tin","To√°n","","L√Ω","SHL"]];
            (data.length ? data : def).forEach((row, rIdx) => {
                let tr = document.createElement('tr');
                row.forEach((cell, cIdx) => {
                    let td = document.createElement('td'); 
                    td.innerText = (rIdx === 3 && cIdx === 4) ? "" : cell;
                    if (cIdx !== 0) td.contentEditable = "true";
                    if (rIdx === 3 && cIdx === 4) { 
                        td.id = "v-key"; 
                        td.addEventListener('keypress', e => { 
                            if(e.key === 'Enter') { e.preventDefault(); unlock(); }
                        }); 
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
